// prisma/schema.prisma
// Modelo de datos para ERP Construcción MX

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// CORE: Multi-tenancy y Autenticación
// ============================================

// Empresa (tenant principal)
model Empresa {
  id            String   @id @default(cuid())
  nombre        String
  rfc           String   @unique
  razonSocial   String
  regimenFiscal String?
  codigoPostal  String?
  direccion     String?
  telefono      String?
  email         String?
  logo          String?
  openaiApiKey  String?  // Clave para integración IA
  activa        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  usuarios       UsuarioEmpresa[]
  obras          Obra[]
  clientes       Cliente[]
  proveedores    Proveedor[]
  productos      Producto[]
  unidades       Unidad[]
  categorias     Categoria[]
  maquinaria     Maquinaria[]
  ordenesCompra  OrdenCompra[]
  CuentaBancaria CuentaBancaria[]
  facturas       Factura[]
  cuentasContables CuentaContable[]
  polizas          Poliza[]

  @@map("empresas")
}

// Usuario del sistema
model Usuario {
  id        String   @id @default(cuid())
  authId    String   @unique // ID de Supabase Auth
  email     String   @unique
  nombre    String
  apellidos String?
  telefono  String?
  avatar    String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  empresas UsuarioEmpresa[]

  @@map("usuarios")
}

// Relación Usuario-Empresa (muchos a muchos con rol)
model UsuarioEmpresa {
  id        String   @id @default(cuid())
  usuarioId String
  empresaId String
  rol       Rol      @default(USUARIO)
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, empresaId])
  @@map("usuarios_empresas")
}

enum Rol {
  ADMIN // Administrador general
  CONTADOR // Acceso a contabilidad
  VENTAS // Ventas y facturación
  COMPRAS // Compras y proveedores
  OBRAS // Gestión de obras
  ALMACEN // Gestión de inventarios
  USUARIO // Usuario básico (solo lectura)
}

// ============================================
// MÓDULO: Gestión de Obras y Proyectos
// ============================================

model Obra {
  id           String       @id @default(cuid())
  empresaId    String
  codigo       String // Código interno de la obra
  nombre       String
  descripcion  String?
  ubicacion    String?
  estado       EstadoObra   @default(EN_PROCESO)
  tipoContrato TipoContrato @default(PRECIO_ALZADO)

  // Fechas
  fechaInicio        DateTime?
  fechaFinProgramada DateTime?
  fechaFinReal       DateTime?

  // Montos
  montoContrato Decimal @default(0) @db.Decimal(18, 2)
  anticipoPct   Decimal @default(0) @db.Decimal(5, 2) // % de anticipo
  retencionPct  Decimal @default(0) @db.Decimal(5, 2) // % de retención

  // Cliente
  clienteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  empresa                Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente                Cliente?               @relation(fields: [clienteId], references: [id])
  contratos              Contrato[]
  presupuestos           Presupuesto[]
  estimaciones           Estimacion[]
  asignacionesMaquinaria AsignacionMaquinaria[]
  ordenesCompra          OrdenCompra[]
  movimientosMaterial    MovimientoInventario[]

  @@unique([empresaId, codigo])
  @@map("obras")
}

enum EstadoObra {
  COTIZACION
  CONTRATADA
  EN_PROCESO
  SUSPENDIDA
  TERMINADA
  CANCELADA
}

enum TipoContrato {
  PRECIO_ALZADO // Monto fijo
  PRECIOS_UNITARIOS // Por unidad ejecutada
  ADMINISTRACION // Costo + fee
  MIXTO
}

model Contrato {
  id            String    @id @default(cuid())
  obraId        String
  numero        String // Número de contrato
  descripcion   String?
  montoOriginal Decimal   @db.Decimal(18, 2)
  montoActual   Decimal   @db.Decimal(18, 2) // Con convenios
  fechaContrato DateTime
  fechaInicio   DateTime?
  fechaTermino  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  obra Obra @relation(fields: [obraId], references: [id], onDelete: Cascade)

  @@map("contratos")
}

model Presupuesto {
  id          String  @id @default(cuid())
  obraId      String
  version     Int     @default(1)
  nombre      String
  descripcion String?
  esVigente   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  obra      Obra                  @relation(fields: [obraId], references: [id], onDelete: Cascade)
  conceptos ConceptoPresupuesto[]

  @@map("presupuestos")
}

model ConceptoPresupuesto {
  id             String  @id @default(cuid())
  presupuestoId  String
  clave          String // Clave del concepto
  descripcion    String
  unidadId       String?
  cantidad       Decimal @db.Decimal(18, 4)
  precioUnitario Decimal @db.Decimal(18, 4)
  importe        Decimal @db.Decimal(18, 2) // cantidad * precioUnitario

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  presupuesto  Presupuesto          @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)
  unidad       Unidad?              @relation(fields: [unidadId], references: [id])
  estimaciones ConceptoEstimacion[]

  @@map("conceptos_presupuesto")
}

model Estimacion {
  id         String           @id @default(cuid())
  obraId     String
  numero     Int // Número de estimación
  periodo    String // "2024-01" formato año-mes
  fechaCorte DateTime
  estado     EstadoEstimacion @default(BORRADOR)

  // Montos
  importeBruto Decimal @db.Decimal(18, 2)
  amortizacion Decimal @default(0) @db.Decimal(18, 2)
  retencion    Decimal @default(0) @db.Decimal(18, 2)
  importeNeto     Decimal         @db.Decimal(18, 2)
  
  pagado          Decimal         @default(0) @db.Decimal(18, 2)
  saldo           Decimal         @default(0) @db.Decimal(18, 2)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  obra            Obra            @relation(fields: [obraId], references: [id], onDelete: Cascade)
  conceptos       ConceptoEstimacion[]
  transacciones   Transaccion[]
  facturas        Factura[]

  @@unique([obraId, numero])
  @@map("estimaciones")
}

enum EstadoEstimacion {
  BORRADOR
  ENVIADA
  APROBADA
  FACTURADA
  PAGADA
  RECHAZADA
}

model ConceptoEstimacion {
  id                    String  @id @default(cuid())
  estimacionId          String
  conceptoPresupuestoId String
  cantidadEjecutada     Decimal @db.Decimal(18, 4) // Cantidad en este período
  cantidadAcumulada     Decimal @db.Decimal(18, 4) // Total acumulado
  importe               Decimal @db.Decimal(18, 2) // Importe de este período

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estimacion          Estimacion          @relation(fields: [estimacionId], references: [id], onDelete: Cascade)
  conceptoPresupuesto ConceptoPresupuesto @relation(fields: [conceptoPresupuestoId], references: [id])

  @@unique([estimacionId, conceptoPresupuestoId])
  @@map("conceptos_estimacion")
}

// ============================================
// MÓDULO: Catálogos
// ============================================

model Cliente {
  id              String  @id @default(cuid())
  empresaId       String
  codigo          String?
  rfc             String
  razonSocial     String
  nombreComercial String?
  regimenFiscal   String?
  usoCfdi         String? @default("G03") // Gastos en general

  // Dirección fiscal
  calle        String?
  numExterior  String?
  numInterior  String?
  colonia      String?
  codigoPostal String?
  municipio    String?
  estado       String?
  pais         String? @default("MEX")

  // Contacto
  email    String?
  telefono String?
  contacto String?

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  obras   Obra[]
  facturas Factura[]

  @@unique([empresaId, rfc])
  @@map("clientes")
}

model Proveedor {
  id              String  @id @default(cuid())
  empresaId       String
  codigo          String?
  rfc             String
  razonSocial     String
  nombreComercial String?

  // Dirección
  calle        String?
  numExterior  String?
  numInterior  String?
  colonia      String?
  codigoPostal String?
  municipio    String?
  estado       String?
  pais         String? @default("MEX")

  // Contacto
  email    String?
  telefono String?
  contacto String?

  // Bancario
  banco  String?
  cuenta String?
  clabe  String?

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa       Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  ordenesCompra OrdenCompra[]

  @@unique([empresaId, rfc])
  @@map("proveedores")
}

model Producto {
  id          String  @id @default(cuid())
  empresaId   String
  codigo      String
  descripcion String
  categoriaId String?
  unidadId    String?

  // SAT
  claveSat       String? // Clave producto/servicio SAT
  claveUnidadSat String? // Clave unidad SAT

  // Precios
  precioCompra Decimal @default(0) @db.Decimal(18, 4)
  precioVenta  Decimal @default(0) @db.Decimal(18, 4)

  // Control
  esServicio   Boolean @default(false)
  controlStock Boolean @default(true)
  stockMinimo  Decimal @default(0) @db.Decimal(18, 4)
  stockActual  Decimal @default(0) @db.Decimal(18, 4)

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa        Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  categoria      Categoria?             @relation(fields: [categoriaId], references: [id])
  unidad         Unidad?                @relation(fields: [unidadId], references: [id])
  movimientos    MovimientoInventario[]
  detallesCompra DetalleOrdenCompra[]

  @@unique([empresaId, codigo])
  @@map("productos")
}

model Categoria {
  id          String  @id @default(cuid())
  empresaId   String
  nombre      String
  descripcion String?
  color       String? // Para UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa   Empresa    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  productos Producto[]

  @@unique([empresaId, nombre])
  @@map("categorias")
}

model Unidad {
  id          String  @id @default(cuid())
  empresaId   String
  nombre      String // "Pieza", "Metro", "Kg"
  abreviatura String // "PZA", "M", "KG"
  claveSat    String? // Clave SAT de unidad

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa   Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  productos Producto[]
  conceptos ConceptoPresupuesto[]
  // Maquinaria not strictly related to Unidad, but useful for compatibility

  @@unique([empresaId, abreviatura])
  @@map("unidades")
}

// ============================================
// MÓDULO: Maquinaria y Equipo
// ============================================

model Maquinaria {
  id          String           @id @default(cuid())
  empresaId   String
  codigo      String // Codigo económico (e.g. R-01)
  descripcion String
  marca       String?
  modelo      String?
  serie       String?
  anio        Int?
  estado      EstadoMaquinaria @default(DISPONIBLE)

  // Costos
  costoHora     Decimal @default(0) @db.Decimal(18, 2)
  costoRentaDia Decimal @default(0) @db.Decimal(18, 2)

  // Control
  horometroActual Decimal @default(0) @db.Decimal(18, 1)
  ubicacionActual String? // Texto libre o relación a Obra si está asignada

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa        Empresa                   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  asignaciones   AsignacionMaquinaria[]
  mantenimientos MantenimientoMaquinaria[]
  registrosUso   RegistroUsoMaquinaria[]

  @@unique([empresaId, codigo])
  @@map("maquinaria")
}

enum EstadoMaquinaria {
  DISPONIBLE
  EN_OBRA
  MANTENIMIENTO
  REPARACION
  BAJA
}

model AsignacionMaquinaria {
  id           String @id @default(cuid())
  maquinariaId String
  obraId       String

  fechaInicio DateTime  @default(now())
  fechaFin    DateTime?

  horometroInicio Decimal  @default(0) @db.Decimal(18, 1)
  horometroFin    Decimal? @db.Decimal(18, 1)

  activo        Boolean @default(true) // Si está actualmente asignada
  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maquinaria Maquinaria @relation(fields: [maquinariaId], references: [id], onDelete: Cascade)
  obra       Obra       @relation(fields: [obraId], references: [id], onDelete: Cascade)

  @@map("asignaciones_maquinaria")
}

model RegistroUsoMaquinaria {
  id           String  @id @default(cuid())
  maquinariaId String
  obraId       String? // Opcional, idealmente vinculado a la obra donde se usó

  fecha    DateTime
  operador String?

  horometroInicial Decimal @db.Decimal(18, 1)
  horometroFinal   Decimal @db.Decimal(18, 1)
  horasTrabajadas  Decimal @db.Decimal(18, 1) // Calculado o manual

  combustibleLitros Decimal @default(0) @db.Decimal(18, 2)
  observaciones     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maquinaria Maquinaria @relation(fields: [maquinariaId], references: [id], onDelete: Cascade)

  @@map("registros_uso_maquinaria")
}

model MantenimientoMaquinaria {
  id           String @id @default(cuid())
  maquinariaId String

  tipo            TipoMantenimiento @default(PREVENTIVO)
  fechaProgramada DateTime
  fechaReal       DateTime?

  horometroProgramado Decimal? @db.Decimal(18, 1)
  horometroReal       Decimal? @db.Decimal(18, 1)

  descripcion String
  costo       Decimal @default(0) @db.Decimal(18, 2)
  proveedor   String? // Taller o mecánico

  estado    EstadoMantenimiento @default(PENDIENTE)
  realizado Boolean             @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maquinaria Maquinaria @relation(fields: [maquinariaId], references: [id], onDelete: Cascade)

  @@map("mantenimientos_maquinaria")
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
}

enum EstadoMantenimiento {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
  CANCELADO
}

// ============================================
// MÓDULO: Compras e Inventarios
// ============================================

model OrdenCompra {
  id          String  @id @default(cuid())
  empresaId   String
  proveedorId String
  obraId      String? // Opcional, si la compra es directa para una obra

  folio        Int // Folio interno
  fecha        DateTime  @default(now())
  fechaEntrega DateTime?

  estado EstadoOrdenCompra @default(BORRADOR)

  subtotal Decimal @default(0) @db.Decimal(18, 2)
  iva      Decimal @default(0) @db.Decimal(18, 2)
  total    Decimal @default(0) @db.Decimal(18, 2)

  pagado Decimal @default(0) @db.Decimal(18, 2)
  saldo  Decimal @default(0) @db.Decimal(18, 2)

  notas String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa       Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  proveedor     Proveedor            @relation(fields: [proveedorId], references: [id])
  obra          Obra?                @relation(fields: [obraId], references: [id])
  detalles      DetalleOrdenCompra[]
  transacciones Transaccion[]

  @@unique([empresaId, folio])
  @@map("ordenes_compra")
}

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  PARCIAL // Recibida parcialmente
  COMPLETADA // Recibida totalmente
  CANCELADA
}

model DetalleOrdenCompra {
  id            String @id @default(cuid())
  ordenCompraId String
  productoId    String

  cantidad         Decimal @db.Decimal(18, 4)
  cantidadRecibida Decimal @default(0) @db.Decimal(18, 4)

  precioUnitario Decimal @db.Decimal(18, 4)
  importe        Decimal @db.Decimal(18, 2)

  ordenCompra OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  producto    Producto    @relation(fields: [productoId], references: [id])

  @@map("detalles_orden_compra")
}

model MovimientoInventario {
  id         String @id @default(cuid())
  productoId String

  tipo          TipoMovimiento
  cantidad      Decimal        @db.Decimal(18, 4)
  costoUnitario Decimal        @default(0) @db.Decimal(18, 4) // Costo al momento del movimiento

  referencia    String? // ID de Orden Compra u otra referencia externa
  obraId        String? // Opcional, para asignar costo a obra
  observaciones String?

  fecha     DateTime @default(now())
  createdAt DateTime @default(now())

  producto Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  obra     Obra?    @relation(fields: [obraId], references: [id])

  @@map("movimientos_inventario")
}

enum TipoMovimiento {
  COMPRA
  SALIDA_OBRA
  DEVOLUCION_OBRA
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
}

// ============================================
// MÓDULO: Tesorería (NUEVO)
// ============================================

model CuentaBancaria {
  id        String @id @default(cuid())
  empresaId String

  alias        String // Ej. "Banorte Principal"
  banco        String // Ej. "BANORTE"
  numeroCuenta String
  clabe        String?
  moneda       String  @default("MXN")

  saldo Decimal @default(0) @db.Decimal(18, 2)

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa       Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  transacciones Transaccion[]

  @@map("cuentas_bancarias")
}

model Transaccion {
  id       String @id @default(cuid())
  cuentaId String

  tipo  TipoTransaccion // INGRESO, EGRESO
  monto Decimal         @db.Decimal(18, 2)
  fecha DateTime        @default(now())

  referencia String? // Num. Autorizacion, Cheque
  concepto   String

  // Relaciones Polimórficas (Opcionales)
  ordenCompraId String?
  estimacionId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cuenta      CuentaBancaria @relation(fields: [cuentaId], references: [id], onDelete: Cascade)
  ordenCompra OrdenCompra?   @relation(fields: [ordenCompraId], references: [id])
  estimacion  Estimacion?    @relation(fields: [estimacionId], references: [id])

  @@map("transacciones")
}

enum TipoTransaccion {
  INGRESO
  EGRESO
}

// ============================================
// MÓDULO: Facturación (NUEVO)
// ============================================

model Factura {
  id          String   @id @default(cuid())
  empresaId   String
  clienteId   String
  estimacionId String? // Opcional, si viene de estimación

  // Datos Fiscales
  serie       String?
  folio       Int
  uuid        String?  @unique // Folio Fiscal (al timbrar)
  
  fecha       DateTime @default(now())
  formaPago   String // 03 Transferencia, etc.
  metodoPago  String // PUE, PPD
  usoCfdi     String // G03, etc.

  // Montos
  subtotal    Decimal  @db.Decimal(18, 2)
  iva         Decimal  @db.Decimal(18, 2)
  total       Decimal  @db.Decimal(18, 2)

  estado      EstadoFactura @default(BORRADOR)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  empresa     Empresa     @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente     Cliente     @relation(fields: [clienteId], references: [id])
  estimacion  Estimacion? @relation(fields: [estimacionId], references: [id])
  detalles    DetalleFactura[]

  @@unique([empresaId, serie, folio])
  @@map("facturas")
}

enum EstadoFactura {
  BORRADOR
  TIMBRADA
  CANCELADA
}

model DetalleFactura {
  id        String @id @default(cuid())
  facturaId String

  claveSat  String // 84111506
  descripcion String
  
  cantidad  Decimal @db.Decimal(18, 4)
  valorUnitario Decimal @db.Decimal(18, 4)
  importe   Decimal @db.Decimal(18, 2)

  factura   Factura @relation(fields: [facturaId], references: [id], onDelete: Cascade)

  @@map("detalles_factura")
}

// ============================================
// MÓDULO: Contabilidad (NUEVO)
// ============================================

model CuentaContable {
  id        String @id @default(cuid())
  empresaId String

  codigo String
  nombre String
  tipo   TipoCuenta
  nivel  Int        @default(1)

  padreId String?
  padre   CuentaContable?  @relation("JerarquiaCuentas", fields: [padreId], references: [id])
  hijos   CuentaContable[] @relation("JerarquiaCuentas")

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa  Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  detalles DetallePoliza[]

  @@unique([empresaId, codigo])
  @@map("cuentas_contables")
}

enum TipoCuenta {
  ACTIVO
  PASIVO
  CAPITAL
  INGRESOS
  EGRESOS
  ORDEN
}

model Poliza {
  id        String @id @default(cuid())
  empresaId String

  tipo     TipoPoliza
  folio    Int
  fecha    DateTime   @default(now())
  concepto String

  cuadrada Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa  Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  detalles DetallePoliza[]

  @@unique([empresaId, tipo, folio])
  @@map("polizas")
}

enum TipoPoliza {
  DIARIO
  INGRESO
  EGRESO
}

model DetallePoliza {
  id       String @id @default(cuid())
  polizaId String
  cuentaId String

  descripcion String?
  debe        Decimal @default(0) @db.Decimal(18, 2)
  haber       Decimal @default(0) @db.Decimal(18, 2)

  poliza    Poliza         @relation(fields: [polizaId], references: [id], onDelete: Cascade)
  cuenta    CuentaContable @relation(fields: [cuentaId], references: [id])

  @@map("detalles_poliza")
}
